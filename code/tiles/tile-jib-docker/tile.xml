<?xml version="1.0" encoding="UTF-8"?>
<project>

  <properties>
    <main.class>nz.co.asb.engineering.Application</main.class>
    <app.properties>/etc/app/app.properties</app.properties>
    <secret.properties>/etc/app/secret.properties</secret.properties>
    <app.base.properties>-Ddummy=false</app.base.properties>
    <jib-maven-plugin.version>1.2.0</jib-maven-plugin.version>
    <docker.registry>engagementacrdev.azurecr.io</docker.registry>
    <docker.image.from>engagementacrdev.azurecr.io/kubersaurus/base-image:rel-20200519025724.secure</docker.image.from>
    <docker.image.name>kubersaurus/${project.artifactId}</docker.image.name>
    <docker.image.tag>dev</docker.image.tag>
    <docker.auth.username>changeme</docker.auth.username>
    <docker.auth.password>changeme</docker.auth.password>
    <docker.image.port>8080</docker.image.port>
  </properties>

  <build>
    <plugins>
      <plugin>
        <groupId>com.google.cloud.tools</groupId>
        <artifactId>jib-maven-plugin</artifactId>
        <version>${jib-maven-plugin.version}</version>
        <configuration>
          <from>
            <image>${docker.image.from}</image>
          </from>
          <container>
            <ports>
              <port>${docker.image.port}</port>
            </ports>
            <useCurrentTimestamp>true</useCurrentTimestamp>
            <mainClass>bathe.BatheBooter</mainClass>
            <jvmFlags>
              <jvmFlag>--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED</jvmFlag>
              <jvmFlag>-Dio.netty.tryReflectionSetAccessible=true</jvmFlag>
              <jvmFlag>--add-opens=java.base/java.nio=ALL-UNNAMED</jvmFlag>
              <jvmFlag>-Xmx1024m</jvmFlag>
            </jvmFlags>
            <args>
              <arg>-R${main.class}</arg>
              <arg>${app.base.properties}</arg>
              <arg>-P${app.properties}</arg>
              <arg>-P${secret.properties}</arg>
            </args>
          </container>
          <to>
            <image>${docker.registry}/${docker.image.name}:${docker.image.tag}</image>
          </to>
        </configuration>
        <executions>
          <execution>
            <id>build-docker</id>
            <phase>install</phase>
            <goals>
              <goal>dockerBuild</goal>
            </goals>
          </execution>
        </executions>
      </plugin>

    </plugins>
  </build>

  <profiles>
    <profile>
      <id>deploy-docker</id>
      <build>
        <plugins>
          <plugin>
            <groupId>com.google.cloud.tools</groupId>
            <artifactId>jib-maven-plugin</artifactId>
            <executions>
              <execution>
                <id>deploy-docker</id>
                <phase>install</phase>
                <goals>
                  <goal>build</goal>
                </goals>
                <configuration>
                </configuration>
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>
    <profile>
      <id>runOnServer</id>
      <properties>
        <docker.image.tag>1.1-SNAPSHOT</docker.image.tag>
      </properties>
    </profile>
  </profiles>
</project>
